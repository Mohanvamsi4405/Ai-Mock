<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mock Interview System - Real Time</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <style>
        :root {
            /* Colors */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            
            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            
            /* Semantic Colors */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            
            /* Typography */
            --font-family-base: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            
            /* Spacing */
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            
            /* Animation */
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        /* Base styles */
        html {
            font-size: var(--font-size-base);
            font-family: var(--font-family-base);
            line-height: var(--line-height-normal);
            color: var(--color-text);
            background-color: var(--color-background);
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
        }
        
        *, *::before, *::after {
            box-sizing: inherit;
        }
        
        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            margin: 0;
            font-weight: var(--font-weight-semibold);
            line-height: var(--line-height-tight);
            color: var(--color-text);
        }
        
        h1 { font-size: var(--font-size-4xl); }
        h2 { font-size: var(--font-size-3xl); }
        h3 { font-size: var(--font-size-2xl); }
        h4 { font-size: var(--font-size-xl); }
        h5 { font-size: var(--font-size-lg); }
        h6 { font-size: var(--font-size-base); }
        
        p {
            margin: 0 0 var(--space-16) 0;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: 500;
            line-height: 1.5;
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            border: none;
            text-decoration: none;
            position: relative;
        }
        
        .btn--primary {
            background: var(--color-primary);
            color: white;
        }
        
        .btn--primary:hover:not(:disabled) {
            background: var(--color-primary-hover);
        }
        
        .btn--primary:active {
            background: var(--color-primary-active);
        }
        
        .btn--secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }
        
        .btn--secondary:hover:not(:disabled) {
            background: var(--color-secondary-hover);
        }
        
        .btn--outline {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }
        
        .btn--outline:hover:not(:disabled) {
            background: var(--color-secondary);
        }
        
        .btn--lg {
            padding: var(--space-12) var(--space-24);
            font-size: var(--font-size-lg);
            border-radius: var(--radius-md);
        }
        
        .btn--sm {
            padding: var(--space-4) var(--space-12);
            font-size: var(--font-size-sm);
        }
        
        .btn--full-width {
            width: 100%;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Form elements */
        .form-control {
            display: block;
            width: 100%;
            padding: var(--space-8) var(--space-12);
            font-size: var(--font-size-base);
            line-height: 1.5;
            color: var(--color-text);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            transition: border-color var(--duration-fast) var(--ease-standard);
        }
        
        .form-control:focus {
            border-color: var(--color-primary);
            outline: 2px solid var(--color-primary);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
        }
        
        .form-group {
            margin-bottom: var(--space-16);
        }
        
        /* Card component */
        .card {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: box-shadow var(--duration-normal) var(--ease-standard);
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card__body {
            padding: var(--space-24);
        }
        
        /* Status indicators */
        .status {
            display: inline-flex;
            align-items: center;
            padding: var(--space-4) var(--space-12);
            border-radius: var(--radius-full);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
        }
        
        .status--success {
            background-color: rgba(var(--color-teal-500-rgb), 0.15);
            color: var(--color-success);
            border: 1px solid rgba(var(--color-teal-500-rgb), 0.25);
        }
        
        .status--error {
            background-color: rgba(var(--color-red-500-rgb), 0.15);
            color: var(--color-error);
            border: 1px solid rgba(var(--color-red-500-rgb), 0.25);
        }
        
        .status--warning {
            background-color: rgba(168, 75, 47, 0.15);
            color: var(--color-warning);
            border: 1px solid rgba(168, 75, 47, 0.25);
        }
        
        /* Container layout */
        .container {
            width: 100%;
            margin-right: auto;
            margin-left: auto;
            padding-right: var(--space-16);
            padding-left: var(--space-16);
            max-width: 1200px;
        }
        
        /* Utility classes */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-4 { gap: var(--space-4); }
        .gap-8 { gap: var(--space-8); }
        .gap-16 { gap: var(--space-16); }
        .hidden { display: none; }
        .block { display: block; }
        
        /* Layout and Structure */
        .header {
            padding: var(--space-24);
            border-bottom: 1px solid var(--color-border);
            margin-bottom: var(--space-32);
        }
        
        .header h1 {
            margin-bottom: var(--space-16);
            text-align: center;
        }
        
        .progress-bar {
            height: 4px;
            background-color: var(--color-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: var(--space-16);
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--color-primary);
            transition: width var(--duration-normal) var(--ease-standard);
            width: 20%;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            gap: var(--space-8);
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: var(--space-8);
            border-radius: var(--radius-base);
            background-color: var(--color-secondary);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            transition: all var(--duration-normal) var(--ease-standard);
            cursor: pointer;
        }
        
        .step.active {
            background-color: var(--color-primary);
            color: white;
        }
        
        .step.completed {
            background-color: var(--color-success);
            color: white;
        }
        
        /* Step Sections */
        .step-section {
            display: none;
            animation: fadeIn var(--duration-normal) var(--ease-standard);
        }
        
        .step-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-32);
            text-align: center;
            transition: all var(--duration-normal) var(--ease-standard);
            cursor: pointer;
            background-color: rgba(59, 130, 246, 0.08);
        }
        
        .upload-area:hover {
            border-color: var(--color-primary);
            background-color: rgba(245, 158, 11, 0.08);
        }
        
        .upload-area.dragover {
            border-color: var(--color-primary);
            background-color: rgba(34, 197, 94, 0.08);
            transform: scale(1.02);
        }
        
        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-16);
        }
        
        .upload-icon {
            font-size: 48px;
            opacity: 0.7;
        }
        
        .upload-link {
            color: var(--color-primary);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
        }
        
        .upload-link:hover {
            text-decoration: underline;
        }
        
        /* Resume Analysis */
        .resume-analysis {
            margin-top: var(--space-24);
            padding: var(--space-24);
            background-color: rgba(239, 68, 68, 0.08);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-24);
            margin: var(--space-24) 0;
        }
        
        .analysis-section h4 {
            margin-bottom: var(--space-12);
            color: var(--color-primary);
            font-size: var(--font-size-lg);
        }
        
        .skills-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-8);
        }
        
        .skill-tag {
            background-color: rgba(147, 51, 234, 0.08);
            color: var(--color-text);
            padding: var(--space-4) var(--space-12);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            border: 1px solid var(--color-border);
        }
        
        /* Interview Screen */
        .interview-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: var(--space-24);
            height: calc(100vh - 100px);
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-24);
        }
        
        .sidebar {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            padding: var(--space-16);
            overflow-y: auto;
        }
        
        .question-panel {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            padding: var(--space-24);
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-16);
            padding-bottom: var(--space-16);
            border-bottom: 1px solid var(--color-border);
        }
        
        .question-category {
            background-color: var(--color-primary);
            color: white;
            padding: var(--space-4) var(--space-12);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }
        
        .question-content {
            flex: 1;
            margin-bottom: var(--space-24);
        }
        
        .question-text {
            font-size: var(--font-size-xl);
            line-height: var(--line-height-normal);
            margin-bottom: var(--space-16);
        }
        
        .recording-controls {
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
            align-items: center;
        }
        
        .mic-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: var(--color-primary);
            color: white;
            font-size: var(--font-size-2xl);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mic-button:hover:not(:disabled) {
            background: var(--color-primary-hover);
            transform: scale(1.05);
        }
        
        .mic-button:active {
            transform: scale(0.95);
        }
        
        .mic-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .mic-button.recording {
            background: var(--color-error);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .speaker-label {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            text-align: center;
            color: var(--color-text-secondary);
        }
        
        .transcript {
            height: 300px;
            overflow-y: auto;
            background-color: rgba(var(--color-slate-900-rgb), 0.05);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin-bottom: var(--space-16);
        }
        
        .transcript-entry {
            margin-bottom: var(--space-12);
            padding: var(--space-12);
            border-radius: var(--radius-base);
        }
        
        .transcript-entry.user {
            background-color: rgba(var(--color-primary), 0.1);
            border-left: 3px solid var(--color-primary);
        }
        
        .transcript-entry.ai {
            background-color: rgba(var(--color-success), 0.1);
            border-left: 3px solid var(--color-success);
        }
        
        .transcript-entry.system {
            background-color: rgba(var(--color-warning), 0.1);
            border-left: 3px solid var(--color-warning);
        }
        
        .transcript-speaker {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-4);
        }
        
        /* Timer */
        .interview-timer {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-success);
            text-align: center;
            margin-bottom: var(--space-16);
        }
        
        .interview-timer.warning {
            color: var(--color-warning);
        }
        
        .interview-timer.critical {
            color: var(--color-error);
            animation: pulse 1s infinite;
        }
        
        /* Code Editor */
        .code-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .code-modal.active {
            display: flex;
        }
        
        .code-modal-content {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            width: 90%;
            max-width: 800px;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .code-editor {
            width: 100%;
            height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: var(--font-size-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            resize: vertical;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .interview-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar {
                order: 2;
            }
            
            .main-content {
                order: 1;
            }
            
            .container {
                padding-right: var(--space-8);
                padding-left: var(--space-8);
            }
        }
        
        /* Error Modal */
        .error-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .error-modal.active {
            display: flex;
        }
        
        .error-modal-content {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            max-width: 500px;
            margin: var(--space-16);
        }
        
        .error-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-16);
        }
        
        .error-modal-title {
            color: var(--color-error);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
        }
        
        .error-modal-close {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            cursor: pointer;
            color: var(--color-text-secondary);
        }
        
        .button-group {
            display: flex;
            gap: var(--space-12);
            justify-content: flex-end;
            margin-top: var(--space-24);
        }
        
        /* Loading Animation */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-border);
            border-top: 2px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: var(--space-8);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Microphone Test Styles */
        .mic-test-section {
            padding: var(--space-24);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            background-color: var(--color-surface);
            margin-bottom: var(--space-24);
        }

        .mic-permission-banner {
            background-color: rgba(var(--color-warning), 0.1);
            border: 1px solid rgba(var(--color-warning), 0.3);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin-bottom: var(--space-16);
            display: none;
        }

        .mic-permission-banner.show {
            display: block;
        }

        .mic-permission-text {
            color: var(--color-warning);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-8);
        }

        .mic-test-controls {
            display: flex;
            gap: var(--space-12);
            align-items: center;
            margin-top: var(--space-16);
        }

        .volume-indicator {
            width: 150px;
            height: 8px;
            background-color: var(--color-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .volume-level {
            height: 100%;
            background: linear-gradient(90deg, var(--color-success) 0%, var(--color-warning) 70%, var(--color-error) 100%);
            width: 0%;
            transition: width 0.1s ease;
        }

        .mic-test-status {
            text-align: center;
            margin: var(--space-16) 0;
        }

        .test-mic-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: var(--color-primary);
            color: white;
            font-size: var(--font-size-xl);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .test-mic-button:hover:not(:disabled) {
            background: var(--color-primary-hover);
            transform: scale(1.05);
        }

        .test-mic-button.recording {
            background: var(--color-error);
            animation: pulse 1.5s infinite;
        }

        .test-mic-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>AI Mock Interview System</h1>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-steps">
                <div class="step active" data-step="1">Resume Upload</div>
                <div class="step" data-step="2">Job Details</div>
                <div class="step" data-step="3">Mic Test</div>
                <div class="step" data-step="4">Interview</div>
                <div class="step" data-step="5">Results</div>
            </div>
        </header>

        <!-- Step 1: Resume Upload -->
        <div class="step-section active" id="step1">
            <div class="card">
                <div class="card__body">
                    <h2>Upload Your Resume</h2>
                    <p>Please upload your resume in PDF format to begin the interview process.</p>
                    
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-content">
                            <div class="upload-icon">ðŸ“„</div>
                            <p>Drop your PDF resume here or <span class="upload-link" id="uploadLink">click to browse</span></p>
                            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Maximum file size: 10MB</p>
                        </div>
                    </div>
                    
                    <input type="file" id="resumeInput" accept=".pdf" style="display: none;">
                    
                    <div id="resumeAnalysis" class="resume-analysis hidden">
                        <h3>Resume Analysis</h3>
                        <div class="analysis-grid">
                            <div class="analysis-section">
                                <h4>Candidate Information</h4>
                                <p><strong>Name:</strong> <span id="candidateName">-</span></p>
                            </div>
                            <div class="analysis-section">
                                <h4>Key Skills</h4>
                                <div id="skillsList" class="skills-list"></div>
                            </div>
                            <div class="analysis-section">
                                <h4>Experience</h4>
                                <div id="experienceList"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn--primary" id="nextToJobDetails" disabled>
                            Next: Job Details
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Job Details -->
        <div class="step-section" id="step2">
            <div class="card">
                <div class="card__body">
                    <h2>Job Description (Optional)</h2>
                    <p>Provide the job description to get tailored questions for the specific role.</p>
                    
                    <div class="form-group">
                        <label class="form-label" for="jobRole">Job Role/Title</label>
                        <input type="text" id="jobRole" class="form-control" placeholder="e.g., Senior Software Engineer">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="jobDescription">Job Description</label>
                        <textarea id="jobDescription" class="form-control" rows="8" 
                                placeholder="Paste the job description here..."></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn--outline" onclick="goToStep(1)">Back</button>
                        <button class="btn btn--primary" id="nextToMicTest">Next: Microphone Test</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Microphone Test -->
        <div class="step-section" id="step3">
            <div class="card">
                <div class="card__body">
                    <h2>Microphone Test</h2>
                    <p>Let's test your microphone to ensure clear audio during the interview.</p>
                    
                    <div class="mic-test-section">
                        <!-- Permission Request -->
                        <div class="mic-permission-banner show" id="micPermissionBanner">
                            <div class="mic-permission-text">
                                ðŸŽ¤ Microphone access is required for the voice interview
                            </div>
                            <p style="font-size: var(--font-size-sm); margin-bottom: var(--space-12);">
                                Click "Allow Microphone" to grant permission, then we'll test the audio quality.
                            </p>
                            <div class="mic-test-controls">
                                <button class="btn btn--primary" id="requestMicBtn">Allow Microphone</button>
                            </div>
                        </div>
                        
                        <!-- Microphone Test Area -->
                        <div id="micTestArea" class="hidden">
                            <!-- Status Display -->
                            <div class="mic-test-status">
                                <div class="status status--success" id="micStatus">ðŸŽ¤ Microphone Connected</div>
                            </div>
                            
                            <!-- Volume Indicator -->
                            <div class="mic-test-controls">
                                <span style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium);">
                                    Volume Level:
                                </span>
                                <div class="volume-indicator">
                                    <div class="volume-level" id="volumeLevel"></div>
                                </div>
                                <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary);" id="volumeText">
                                    Silent
                                </span>
                            </div>
                            
                            <!-- Test Recording Controls -->
                            <div style="text-align: center; margin-top: var(--space-24);">
                                <button class="test-mic-button" id="testMicBtn">ðŸŽ¤</button>
                                <p style="margin-top: var(--space-12); font-size: var(--font-size-base);">
                                    Click to test recording (3 seconds)
                                </p>
                                
                                <div id="testStatus" style="margin-top: var(--space-16); min-height: 60px; 
                                     padding: var(--space-16); background-color: var(--color-secondary); 
                                     border-radius: var(--radius-base); font-size: var(--font-size-sm);">
                                    Ready for test recording. Click the microphone button above.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn--outline" onclick="goToStep(2)">Back</button>
                        <button class="btn btn--primary" id="startInterviewBtn" disabled>Start Interview</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Interview -->
        <div class="step-section" id="step4">
            <div class="interview-layout">
                <div class="main-content">
                    <div class="question-panel">
                        <div class="question-header">
                            <div class="question-category" id="questionCategory">Introduction</div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                Question <span id="questionNumber">1</span> of <span id="totalQuestions">6</span>
                            </div>
                        </div>
                        
                        <div class="question-content">
                            <div class="question-text" id="currentQuestion">
                                Loading your first question...
                            </div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="expectedTime">
                                Expected: 2-3 minutes
                            </div>
                        </div>
                        
                        <div class="recording-controls">
                            <div class="speaker-label" id="speakerLabel">AI is speaking...</div>
                            <button class="mic-button" id="micRecordBtn" disabled>ðŸŽ¤</button>
                            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); text-align: center;">
                                Wait for AI to finish, then speak your answer
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar">
                    <div class="interview-timer" id="interviewTimer">45:00</div>
                    
                    <div style="margin-bottom: var(--space-24);">
                        <h4>Interview Controls</h4>
                        <div class="flex flex-col gap-8">
                            <button class="btn btn--outline btn--sm" id="pauseBtn">Pause</button>
                            <button class="btn btn--outline btn--sm" id="muteBtn">ðŸ”‡ Mute</button>
                            <button class="btn btn--outline btn--sm" onclick="openCodeModal()">Open Code Editor</button>
                            <button class="btn btn--secondary btn--sm" id="endInterviewBtn">End Interview</button>
                        </div>
                    </div>
                    
                    <div>
                        <h4>Conversation Transcript</h4>
                        <div class="transcript" id="transcript">
                            <div class="transcript-entry system">
                                <div class="transcript-speaker">SYSTEM</div>
                                <div>Interview starting soon...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: Results -->
        <div class="step-section" id="step5">
            <div class="card">
                <div class="card__body">
                    <h2>Interview Complete! ðŸŽ‰</h2>
                    <p>Thank you for completing the mock interview. Here's a summary of your session:</p>
                    
                    <div class="analysis-grid">
                        <div class="analysis-section">
                            <h4>Session Summary</h4>
                            <p><strong>Duration:</strong> <span id="totalDuration">-</span> minutes</p>
                            <p><strong>Questions Answered:</strong> <span id="questionsAnswered">-</span></p>
                            <p><strong>Coding Questions:</strong> <span id="codingQuestions">-</span></p>
                        </div>
                        <div class="analysis-section">
                            <h4>Interview Feedback</h4>
                            <div id="interviewFeedback">
                                <p>Generating detailed feedback...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn--outline" onclick="location.reload()">Start New Interview</button>
                        <button class="btn btn--primary" onclick="downloadTranscript()">Download Transcript</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Modal -->
    <div class="code-modal" id="codeModal">
        <div class="code-modal-content">
            <div class="flex justify-between items-center" style="margin-bottom: var(--space-16);">
                <h3>Code Editor</h3>
                <button class="btn btn--outline btn--sm" onclick="closeCodeModal()">Close</button>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="languageSelect">Programming Language</label>
                <select id="languageSelect" class="form-control">
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="java">Java</option>
                    <option value="cpp">C++</option>
                    <option value="sql">SQL</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="codeEditor">Your Code</label>
                <textarea id="codeEditor" class="code-editor" 
                         placeholder="Write your code here..."></textarea>
            </div>
            
            <div class="button-group">
                <button class="btn btn--outline" onclick="clearCode()">Clear</button>
                <button class="btn btn--primary" onclick="submitCode()">Submit Code</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="error-modal" id="errorModal">
        <div class="error-modal-content">
            <div class="error-modal-header">
                <div class="error-modal-title" id="errorTitle">Error</div>
                <button class="error-modal-close" onclick="closeErrorModal()">&times;</button>
            </div>
            <div id="errorMessage">An error occurred.</div>
            <div class="button-group">
                <button class="btn btn--primary" onclick="closeErrorModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000';
        
        // Global variables
        let sessionId = null;
        let currentStep = 1;
        let currentQuestionIndex = 0;
        let interviewTimer = null;
        let timeRemaining = 45 * 60; // 45 minutes in seconds
        let ws = null;
        let isMuted = false;
        let interviewSystem = null;
        
        // Microphone test variables
        let micStream = null;
        let micTestRecorder = null;
        let audioContext = null;
        let analyser = null;
        let volumeAnimationFrame = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Set up event listeners
            setupEventListeners();
            
            // Initialize first step
            goToStep(1);
            
            console.log('App initialized');
        }

        function setupEventListeners() {
            // Resume upload
            const uploadArea = document.getElementById('uploadArea');
            const uploadLink = document.getElementById('uploadLink');
            const resumeInput = document.getElementById('resumeInput');
            
            uploadArea.addEventListener('click', () => resumeInput.click());
            uploadLink.addEventListener('click', (e) => {
                e.stopPropagation();
                resumeInput.click();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleResumeFile(files[0]);
                }
            });
            
            resumeInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleResumeFile(e.target.files[0]);
                }
            });

            // Step navigation
            document.getElementById('nextToJobDetails').addEventListener('click', () => goToStep(2));
            document.getElementById('nextToMicTest').addEventListener('click', setupInterview);

            // Microphone test
            document.getElementById('requestMicBtn').addEventListener('click', requestMicrophoneAccess);
            document.getElementById('testMicBtn').addEventListener('click', toggleMicTest);
            document.getElementById('startInterviewBtn').addEventListener('click', startInterview);

            // Interview controls
            document.getElementById('pauseBtn').addEventListener('click', pauseInterview);
            document.getElementById('muteBtn').addEventListener('click', toggleMute);
            document.getElementById('endInterviewBtn').addEventListener('click', endInterview);
            document.getElementById('micRecordBtn').addEventListener('click', toggleRecording);
        }

        // Step navigation
        function goToStep(step) {
            // Hide all step sections
            document.querySelectorAll('.step-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show target step
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update progress bar and steps
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${(step / 5) * 100}%`;
            
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    stepEl.classList.add('completed');
                } else if (index + 1 === step) {
                    stepEl.classList.add('active');
                }
            });
            
            currentStep = step;
        }

        // Resume handling
        async function handleResumeFile(file) {
            if (!file.type.includes('pdf')) {
                showErrorModal('Invalid File', 'Please upload a PDF file.');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showErrorModal('File Too Large', 'Please upload a file smaller than 10MB.');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE_URL}/upload-resume`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    sessionId = result.sessionId;
                    displayResumeAnalysis(result.parsedContent);
                    document.getElementById('nextToJobDetails').disabled = false;
                } else {
                    showErrorModal('Upload Error', result.message || 'Failed to process resume.');
                }
            } catch (error) {
                console.error('Resume upload error:', error);
                showErrorModal('Upload Error', 'Failed to upload resume. Please try again.');
            }
        }

        function displayResumeAnalysis(parsed) {
            document.getElementById('candidateName').textContent = parsed.candidateName || 'Unknown';
            
            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = '';
            parsed.skills.forEach(skill => {
                const tag = document.createElement('div');
                tag.className = 'skill-tag';
                tag.textContent = skill;
                skillsList.appendChild(tag);
            });
            
            const experienceList = document.getElementById('experienceList');
            experienceList.innerHTML = '';
            if (parsed.experience.length > 0) {
                parsed.experience.slice(0, 3).forEach(exp => {
                    const item = document.createElement('div');
                    item.style.marginBottom = 'var(--space-8)';
                    item.textContent = exp;
                    experienceList.appendChild(item);
                });
            } else {
                experienceList.innerHTML = '<p style="color: var(--color-text-secondary);">No experience details extracted</p>';
            }
            
            document.getElementById('resumeAnalysis').classList.remove('hidden');
        }

        // Interview setup
        async function setupInterview() {
            if (!sessionId) {
                showErrorModal('Session Error', 'Please upload your resume first.');
                return;
            }

            try {
                const jobRole = document.getElementById('jobRole').value || 'General Technical Role';
                const jobDescription = document.getElementById('jobDescription').value || '';

                const response = await fetch(`${API_BASE_URL}/setup-interview`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        job_description: {
                            text: jobDescription,
                            role: jobRole
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('totalQuestions').textContent = result.questions.length;
                    goToStep(3);
                } else {
                    showErrorModal('Setup Error', result.message || 'Failed to setup interview.');
                }
            } catch (error) {
                console.error('Interview setup error:', error);
                showErrorModal('Setup Error', 'Failed to setup interview. Please try again.');
            }
        }

        // Microphone access and testing
        async function requestMicrophoneAccess() {
            const requestBtn = document.getElementById('requestMicBtn');
            const permissionBanner = document.getElementById('micPermissionBanner');
            const testArea = document.getElementById('micTestArea');
            const micStatus = document.getElementById('micStatus');

            try {
                requestBtn.disabled = true;
                requestBtn.innerHTML = '<div class="loading-spinner"></div>Requesting Access...';

                // Request microphone access with enhanced settings
                micStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    }
                });

                // Create audio context for volume monitoring
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(micStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);

                // Hide permission banner and show test area
                permissionBanner.classList.remove('show');
                testArea.classList.remove('hidden');
                
                // Update status
                micStatus.textContent = 'ðŸŽ¤ Microphone Connected Successfully';
                micStatus.className = 'status status--success';

                // Start volume monitoring
                startVolumeMonitoring();

                // Enable start interview button
                document.getElementById('startInterviewBtn').disabled = false;
                
                console.log('Microphone access granted successfully');
                
                // Auto-update status to ready for test after 2 seconds
                setTimeout(() => {
                    updateTestStatus('Ready to test! Click the microphone button to record a 3-second sample.');
                }, 2000);

            } catch (error) {
                console.error('Microphone access error:', error);
                
                // Reset button
                requestBtn.disabled = false;
                requestBtn.textContent = 'Allow Microphone';

                // Show error
                if (error.name === 'NotAllowedError') {
                    showErrorModal('Permission Denied', 
                        'Microphone access was denied. Please click the microphone icon in your browser address bar and allow access, then try again.');
                } else if (error.name === 'NotFoundError') {
                    showErrorModal('No Microphone Found', 
                        'No microphone was detected. Please connect a microphone and try again.');
                } else {
                    showErrorModal('Microphone Error', 
                        `Failed to access microphone: ${error.message}. Please check your browser settings and try again.`);
                }

                // Update status to error
                micStatus.textContent = 'âŒ Microphone Access Failed';
                micStatus.className = 'status status--error';
            }
        }

        function startVolumeMonitoring() {
            const volumeLevel = document.getElementById('volumeLevel');
            const volumeText = document.getElementById('volumeText');
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            function updateVolume() {
                if (!analyser) return;
                
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((sum, value) => sum + value, 0) / dataArray.length;
                const volumePercent = Math.min((average / 128) * 100, 100);
                
                volumeLevel.style.width = `${volumePercent}%`;
                
                // Update volume text
                if (volumePercent < 5) {
                    volumeText.textContent = 'Silent';
                } else if (volumePercent < 20) {
                    volumeText.textContent = 'Low';
                } else if (volumePercent < 50) {
                    volumeText.textContent = 'Good';
                } else if (volumePercent < 80) {
                    volumeText.textContent = 'High';
                } else {
                    volumeText.textContent = 'Very High';
                }
                
                volumeAnimationFrame = requestAnimationFrame(updateVolume);
            }
            
            updateVolume();
        }

        function updateTestStatus(message, isError = false) {
            const testStatus = document.getElementById('testStatus');
            testStatus.textContent = message;
            testStatus.style.backgroundColor = isError ? 
                'rgba(var(--color-red-500-rgb), 0.1)' : 
                'var(--color-secondary)';
        }

        // Microphone test recording
        let isTestRecording = false;

        async function toggleMicTest() {
            const testBtn = document.getElementById('testMicBtn');
            
            if (!micStream) {
                showErrorModal('Microphone Error', 'Please allow microphone access first.');
                return;
            }

            if (!isTestRecording) {
                await startMicTest();
            } else {
                await stopMicTest();
            }
        }

        async function startMicTest() {
            const testBtn = document.getElementById('testMicBtn');
            
            try {
                isTestRecording = true;
                testBtn.classList.add('recording');
                testBtn.textContent = 'ðŸ”´';
                testBtn.disabled = true;
                
                updateTestStatus('ðŸŽ¤ Recording... Speak now! (3 seconds)');

                // Create MediaRecorder for test
                const options = { mimeType: 'audio/webm;codecs=opus' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'audio/wav';
                }
                
                micTestRecorder = new MediaRecorder(micStream, options);
                let audioChunks = [];
                
                micTestRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                micTestRecorder.onstop = () => {
                    if (audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        updateTestStatus(`âœ… Test successful! Recorded ${Math.round(audioBlob.size / 1024)}KB of audio. Your microphone is working properly.`);
                        
                        // Enable start interview button
                        const startBtn = document.getElementById('startInterviewBtn');
                        if (startBtn) {
                            startBtn.disabled = false;
                            startBtn.innerHTML = '<span style="color: green;">âœ“</span> Start Interview';
                        }
                    } else {
                        updateTestStatus('âš ï¸ Test completed but no audio was captured. Please try speaking closer to your microphone.', true);
                    }
                    audioChunks = [];
                };

                micTestRecorder.start();
                
                // Auto-stop after 3 seconds
                setTimeout(() => {
                    if (isTestRecording && micTestRecorder && micTestRecorder.state === 'recording') {
                        stopMicTest();
                    }
                }, 3000);

            } catch (error) {
                console.error('Test recording error:', error);
                updateTestStatus(`âŒ Recording test failed: ${error.message}`, true);
                isTestRecording = false;
                testBtn.classList.remove('recording');
                testBtn.textContent = 'ðŸŽ¤';
                testBtn.disabled = false;
            }
        }

        async function stopMicTest() {
            const testBtn = document.getElementById('testMicBtn');
            
            isTestRecording = false;
            testBtn.classList.remove('recording');
            testBtn.textContent = 'ðŸŽ¤';
            testBtn.disabled = false;
            
            if (micTestRecorder && micTestRecorder.state === 'recording') {
                micTestRecorder.stop();
                updateTestStatus('â³ Processing test recording...');
            }
        }

        // Enhanced InterviewSystem class
        class InterviewSystem {
            constructor() {
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.isRecording = false;
                this.stream = micStream; // Use the global mic stream
            }

            async initialize() {
                if (!this.stream) {
                    throw new Error('Microphone stream not available. Please complete microphone test first.');
                }
                
                try {
                    // Test MediaRecorder compatibility
                    const options = { mimeType: 'audio/webm;codecs=opus' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options.mimeType = 'audio/wav';
                    }
                    
                    this.mediaRecorder = new MediaRecorder(this.stream, options);
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        if (this.audioChunks.length > 0) {
                            const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                            this.sendAudioToServer(audioBlob);
                        }
                        this.audioChunks = [];
                    };
                    
                    this.mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder error:', event.error);
                        this.forceStopRecording();
                        showErrorModal('Recording Error', 'Failed to record audio. Please check your microphone.');
                    };
                    
                    console.log('InterviewSystem initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize MediaRecorder:', error);
                    throw new Error('Failed to initialize recording system');
                }
            }

            async startRecording() {
                if (!this.mediaRecorder) {
                    throw new Error('MediaRecorder not initialized');
                }
                
                if (this.isRecording) {
                    console.warn('Already recording, ignoring start request');
                    return;
                }
                
                try {
                    this.audioChunks = [];
                    this.isRecording = true;
                    this.mediaRecorder.start();
                    
                    const micBtn = document.getElementById('micRecordBtn');
                    if (micBtn) {
                        micBtn.classList.add('recording');
                        micBtn.textContent = 'ðŸ”´';
                        micBtn.disabled = false;
                    }
                    
                    document.getElementById('speakerLabel').textContent = 'You are speaking...';
                    console.log('Recording started');
                } catch (error) {
                    console.error('Failed to start recording:', error);
                    this.isRecording = false;
                    throw error;
                }
            }

            async stopRecording() {
                if (!this.isRecording || !this.mediaRecorder) {
                    console.warn('Not recording, ignoring stop request');
                    return;
                }
                
                try {
                    this.isRecording = false;
                    this.mediaRecorder.stop();
                    
                    const micBtn = document.getElementById('micRecordBtn');
                    if (micBtn) {
                        micBtn.classList.remove('recording');
                        micBtn.textContent = 'ðŸŽ¤';
                        micBtn.disabled = true;
                    }
                    
                    document.getElementById('speakerLabel').textContent = 'Processing your response...';
                    console.log('Recording stopped');
                } catch (error) {
                    console.error('Failed to stop recording:', error);
                    throw error;
                }
            }

            forceStopRecording() {
                this.isRecording = false;
                
                if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                    try {
                        this.mediaRecorder.stop();
                    } catch (error) {
                        console.error('Error force stopping recorder:', error);
                    }
                }
                
                const micBtn = document.getElementById('micRecordBtn');
                if (micBtn) {
                    micBtn.classList.remove('recording');
                    micBtn.textContent = 'ðŸŽ¤';
                    micBtn.disabled = false;
                }
            }

            async sendAudioToServer(audioBlob) {
                if (!ws || ws.readyState !== WebSocket.OPEN) {
                    console.error('WebSocket not connected');
                    showErrorModal('Connection Error', 'Lost connection to interview system.');
                    return;
                }
                
                try {
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const base64Audio = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
                    
                    ws.send(JSON.stringify({
                        type: 'audio',
                        content: base64Audio
                    }));
                    
                    console.log('Audio sent to server');
                } catch (error) {
                    console.error('Error sending audio:', error);
                    showErrorModal('Upload Error', 'Failed to send audio to server.');
                }
            }
        }

        // Recording controls
        async function toggleRecording() {
            if (!interviewSystem) {
                showErrorModal('System Error', 'Recording system not initialized. Please refresh the page.');
                return;
            }
            
            if (!interviewSystem.isRecording) {
                try {
                    await interviewSystem.startRecording();
                } catch (error) {
                    console.error('Failed to start recording:', error);
                    showErrorModal('Recording Error', 'Failed to start recording. Please check microphone access.');
                }
            } else {
                try {
                    await interviewSystem.stopRecording();
                } catch (error) {
                    console.error('Failed to stop recording:', error);
                    showErrorModal('Recording Error', 'Failed to stop recording.');
                }
            }
        }

        // Text-to-Speech with auto-recording start
        function playAudio(audioData, textContent) {
            if (isMuted || !textContent) {
                // If muted or no content, start recording immediately
                setTimeout(() => {
                    if (interviewSystem && !interviewSystem.isRecording) {
                        interviewSystem.startRecording();
                    }
                    const micBtn = document.getElementById('micRecordBtn');
                    if (micBtn) {
                        micBtn.disabled = false;
                        micBtn.textContent = 'Tap to Finish Speaking';
                    }
                    document.getElementById('speakerLabel').textContent = 'Your turn to speak';
                }, 500);
                return;
            }

            // Use Web Speech API for TTS
            const utterance = new SpeechSynthesisUtterance(textContent);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;

            utterance.onstart = () => {
                document.getElementById('speakerLabel').textContent = 'AI is speaking...';
                const micBtn = document.getElementById('micRecordBtn');
                if (micBtn) {
                    micBtn.disabled = true;
                    micBtn.textContent = 'AI Speaking...';
                }
            };

            utterance.onend = () => {
                // AI finished speaking, automatically start recording
                setTimeout(() => {
                    if (interviewSystem && !interviewSystem.isRecording) {
                        interviewSystem.startRecording();
                    }
                    const micBtn = document.getElementById('micRecordBtn');
                    if (micBtn) {
                        micBtn.disabled = false;
                        micBtn.textContent = 'Tap to Finish Speaking';
                    }
                    document.getElementById('speakerLabel').textContent = 'Your turn to speak';
                    
                    // Notify backend that AI finished speaking
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'ai_finished_speaking' }));
                    }
                }, 500);
            };

            utterance.onerror = (error) => {
                console.error('Speech synthesis error:', error);
                // Fallback to immediate recording start
                setTimeout(() => {
                    if (interviewSystem && !interviewSystem.isRecording) {
                        interviewSystem.startRecording();
                    }
                    const micBtn = document.getElementById('micRecordBtn');
                    if (micBtn) {
                        micBtn.disabled = false;
                        micBtn.textContent = 'Tap to Finish Speaking';
                    }
                    document.getElementById('speakerLabel').textContent = 'Your turn to speak';
                }, 500);
            };

            speechSynthesis.speak(utterance);
        }

        // WebSocket message handling
        function handleWebSocketMessage(event) {
            const micRecordBtn = document.getElementById('micRecordBtn');
            
            try {
                const message = JSON.parse(event.data);
                console.log('Received WebSocket message:', message.type);
                
                switch (message.type) {
                    case 'ai_message':
                        // AI sends a question or response
                        const questionText = message.content;
                        const questionCategory = message.category || 'Follow-up';
                        
                        // Update UI (Question Panel)
                        document.getElementById('currentQuestion').innerHTML = questionText;
                        document.getElementById('questionCategory').textContent = questionCategory;
                        
                        const expectedTimeText = message.requiresCode 
                            ? 'Expected: 5-10 minutes (Coding)' 
                            : (questionCategory === 'Behavioral' ? 'Expected: 3-5 minutes' : 'Expected: 2-3 minutes');
                        document.getElementById('expectedTime').textContent = expectedTimeText;
                        
                        // Play audio (handles auto-transcription and auto-start recording)
                        playAudio(message.audio, message.content);
                        
                        // Update index for display purposes
                        if (message.questionNumber) {
                            currentQuestionIndex = message.questionNumber - 1;
                            document.getElementById('questionNumber').textContent = message.questionNumber;
                        }
                        break;

                    case 'transcription':
                        // User speech transcription
                        addToTranscript('user', message.content); 
                        break;

                    case 'resume_listening':
                    case 'continue_listening':
                        // Backend is waiting for more input
                        if (!interviewSystem.isRecording) {
                            interviewSystem.startRecording();
                        }
                        break;
                        
                    case 'start_recording':
                        // Backend explicitly requests recording start
                        if (!interviewSystem.isRecording) {
                            interviewSystem.startRecording();
                        }
                        break;
                        
                    case 'interview_completed':
                        const feedback = message.feedback || 'The interview is complete. Generating final feedback...';
                        addToTranscript('system', 'âœ… Interview flow concluded.');
                        document.getElementById('interviewFeedback').innerHTML = `<p>${feedback}</p>`;
                        endInterview();
                        break;
                        
                    case 'error':
                        showErrorModal('Interview Error', message.content);
                        if (micRecordBtn) {
                            micRecordBtn.disabled = false;
                            micRecordBtn.textContent = 'Retry Speaking';
                        }
                        interviewSystem.forceStopRecording();
                        break;

                    case 'processing_response':
                    case 'ai_responding':
                    case 'ai_evaluating_code':
                        document.getElementById('speakerLabel').textContent = 'AI is thinking/processing...';
                        if (micRecordBtn) micRecordBtn.disabled = true;
                        break;
                }
            } catch (e) {
                console.error("Error handling WebSocket message:", e);
                if (micRecordBtn) micRecordBtn.disabled = false;
            }
        }

        // Start Interview function: Uses WebSocket
        function startInterview() {
            if (!sessionId) {
                showErrorModal('Setup Required', 'Please complete the Resume and Job Details steps.');
                return;
            }

            if (!micStream) {
                showErrorModal('Microphone Required', 'Please complete the microphone test first.');
                return;
            }
            
            goToStep(4);
            startInterviewTimer();

            // Initialize InterviewSystem with the existing stream
            interviewSystem = new InterviewSystem();
            interviewSystem.initialize().then(() => {
                // Establish WebSocket Connection
                const wsUrl = API_BASE_URL.replace('http', 'ws') + `/ws/${sessionId}`;
                ws = new WebSocket(wsUrl);

                const micRecordBtn = document.getElementById('micRecordBtn');
                
                ws.onopen = () => {
                    console.log("WebSocket connected. Starting interview flow.");
                    document.getElementById('speakerLabel').textContent = 'AI is speaking...';
                    if (micRecordBtn) {
                         micRecordBtn.disabled = true;
                         micRecordBtn.textContent = 'Awaiting AI Response...';
                    }
                };

                ws.onmessage = handleWebSocketMessage;
                
                ws.onclose = (event) => {
                    console.warn("WebSocket closed:", event);
                    if (event.code !== 1000) { 
                        showErrorModal('Connection Lost', 'The interview connection was unexpectedly closed. Please restart.');
                        pauseInterview(); 
                    }
                };
                
                ws.onerror = (error) => {
                    console.error("WebSocket error:", error);
                    showErrorModal('Network Error', 'Could not establish real-time connection with the server.');
                    pauseInterview();
                };

                document.getElementById('speakerLabel').textContent = 'Initializing AI Interviewer...';
            }).catch(error => {
                console.error('Failed to initialize interview system:', error);
                showErrorModal('Initialization Error', 'Failed to setup interview system. Please refresh and try again.');
            });
        }

        // Timer functions
        function startInterviewTimer() {
            if (interviewTimer) {
                clearInterval(interviewTimer);
            }
            
            timeRemaining = 45 * 60; 
            
            interviewTimer = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    endInterview();
                } else if (timeRemaining === 300) { 
                    addToTranscript('system', 'âš ï¸ Warning: 5 minutes remaining in the interview.');
                } else if (timeRemaining === 60) { 
                    addToTranscript('system', 'âš ï¸ Warning: 1 minute remaining in the interview.');
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const timer = document.getElementById('interviewTimer');
            if (timer) {
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                timer.classList.remove('warning', 'critical');

                if (timeRemaining <= 300 && timeRemaining > 60) { 
                    timer.classList.add('warning');
                }
                if (timeRemaining <= 60) { 
                    timer.classList.add('critical');
                }
            }
        }

        function addToTranscript(speaker, text) {
            const transcript = document.getElementById('transcript');
            if (!transcript) return;
            
            const entry = document.createElement('div');
            entry.className = `transcript-entry ${speaker}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `
                <div class="transcript-speaker">${speaker.toUpperCase()} - ${timestamp}</div>
                <div>${text}</div>
            `;
            
            transcript.appendChild(entry);
            transcript.scrollTop = transcript.scrollHeight;
        }

        function pauseInterview() {
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (interviewTimer) {
                clearInterval(interviewTimer);
                interviewTimer = null;
                if (pauseBtn) pauseBtn.textContent = 'Resume';
                speechSynthesis.cancel();
                
                interviewSystem.forceStopRecording(); 
                
                addToTranscript('system', 'â¸ï¸ Interview paused.');
            } else {
                startInterviewTimer();
                if (pauseBtn) pauseBtn.textContent = 'Pause';
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: "ping" }));
                }

                addToTranscript('system', 'â–¶ï¸ Interview resumed. Waiting for AI response or user input.');
            }
        }

        async function endInterview() {
            if (interviewTimer) {
                clearInterval(interviewTimer);
                interviewTimer = null;
            }
            
            speechSynthesis.cancel();
            if (interviewSystem) {
                interviewSystem.forceStopRecording();
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "end_interview" }));
                await new Promise(r => setTimeout(r, 1000));
                ws.close(1000, "Interview ended by user");
            }
            
            // Cleanup microphone resources
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) {
                audioContext.close();
            }
            if (volumeAnimationFrame) {
                cancelAnimationFrame(volumeAnimationFrame);
            }
            
            const duration = Math.round((45 * 60 - timeRemaining) / 60);
            
            const totalDuration = document.getElementById('totalDuration');
            const questionsAnswered = document.getElementById('questionsAnswered');
            const codingQuestions = document.getElementById('codingQuestions');
            
            if (totalDuration) totalDuration.textContent = duration;
            if (questionsAnswered) questionsAnswered.textContent = currentQuestionIndex + 1; 
            if (codingQuestions) codingQuestions.textContent = document.getElementById('codeEditor')?.value?.trim() ? '1' : '0';
            
            goToStep(5);
        }

        function toggleMute() {
            const btn = document.getElementById('muteBtn');
            isMuted = !isMuted;
            
            if (isMuted) {
                speechSynthesis.cancel();
                if (btn) btn.textContent = 'ðŸ”Š Unmute';
                addToTranscript('system', 'ðŸ”‡ Audio muted. AI will only respond via text.');
            } else {
                if (btn) btn.textContent = 'ðŸ”‡ Mute';
                addToTranscript('system', 'ðŸ”Š Audio unmuted. AI responses will now be spoken.');
            }
        }

        // Code editor functions
        function openCodeModal() {
            document.getElementById('codeModal').classList.add('active');
        }

        function closeCodeModal() {
            document.getElementById('codeModal').classList.remove('active');
        }

        function clearCode() {
            document.getElementById('codeEditor').value = '';
        }

        function submitCode() {
            const code = document.getElementById('codeEditor').value;
            const language = document.getElementById('languageSelect').value;
            
            if (!code.trim()) {
                showErrorModal('No Code', 'Please write some code before submitting.');
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'code_submission',
                    content: code,
                    language: language
                }));
            }
            
            closeCodeModal();
            addToTranscript('user', `Submitted ${language} code (${code.length} characters)`);
        }

        // Error modal functions
        function showErrorModal(title, message) {
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.add('active');
        }

        function closeErrorModal() {
            document.getElementById('errorModal').classList.remove('active');
        }

        // Download transcript
        function downloadTranscript() {
            const transcript = document.getElementById('transcript');
            if (!transcript) return;
            
            const entries = transcript.querySelectorAll('.transcript-entry');
            let content = 'Interview Transcript\n\n';
            
            entries.forEach(entry => {
                const speaker = entry.querySelector('.transcript-speaker').textContent;
                const text = entry.querySelector('div:last-child').textContent;
                content += `${speaker}\n${text}\n\n`;
            });
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'interview-transcript.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>